# å•çº¿ç¨‹çš„ JavaScript

## å•çº¿ç¨‹çš„ JavaScript

ä½œä¸ºæµè§ˆå™¨è„šæœ¬è¯­è¨€ï¼ŒJavaScript çš„ä¸»è¦ä½œç”¨æ˜¯ä¸ç”¨æˆ·äº¤äº’å’Œæ“ä½œ DOMã€‚

å¦‚æœ JavaScript æ˜¯å¤šçº¿ç¨‹ï¼Œå½“é¡µé¢æ›´æ–°å†…å®¹çš„æ—¶å€™ï¼Œç”¨æˆ·åˆè§¦å‘äº†äº¤äº’ï¼Œè¿™æ—¶å€™çº¿ç¨‹é—´çš„åŒæ­¥é—®é¢˜ä¼šå¾ˆå¤æ‚ï¼Œä¸ºäº†é¿å…å¤æ‚æ€§ï¼ŒJavaScript è¢«è®¾è®¡ä¸ºå•çº¿ç¨‹ã€‚

### è®¾è®¡ä¸ºå•çº¿ç¨‹çš„æ ¸å¿ƒåŸå› 

JavaScript è®¾è®¡ä¸ºå•çº¿ç¨‹çš„åŸå› ä¸»è¦ä¸`JavaScript çš„è¿è¡Œç¯å¢ƒï¼ˆæµè§ˆå™¨ï¼‰ä»¥åŠå®ƒçš„åˆè¡·`æœ‰å…³ã€‚

æœ€åˆæ˜¯ä¸ºç½‘é¡µæµè§ˆå™¨è®¾è®¡çš„ï¼Œç›®çš„æ˜¯å¤„ç†ç”¨æˆ·ä¸ç½‘é¡µçš„äº¤äº’ï¼Œå› æ­¤å®ƒçš„è®¾è®¡åˆè¡·éå¸¸å¼ºè°ƒç®€æ´æ€§å’Œå®‰å…¨æ€§

æ ¸å¿ƒåŸå› ï¼š

1ã€æµè§ˆå™¨ä¸­çš„DOMæ“ä½œéœ€è¦ç®€åŒ–

> æœ€åˆçš„ä¸»è¦ç”¨é€”æ˜¯ä¸HTMLé¡µé¢äº¤äº’ï¼Œå°¤å…¶æ˜¯æ“ä½œDOMå…ƒç´ ã€‚ç”±äºDOMæ˜¯ä¸€ä¸ªå…±äº«çš„å…¨å±€çŠ¶æ€ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œDOMï¼ˆæ¯”å¦‚åŒæ—¶ä¿®æ”¹å…ƒç´ çš„æ ·å¼æˆ–ç»“æ„ï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†²çªæˆ–ä¸ä¸€è‡´çš„çŠ¶æ€

2ã€ç®€åŒ–å¼€å‘è€…çš„ç¼–ç¨‹æ¨¡å‹

3ã€å†å²åŸå› å’Œåˆè¡·

> JavaScriptè®¾è®¡ä¹‹åˆå¹¶ä¸æ˜¯ä¸ºäº†æ‰§è¡Œå¤æ‚çš„å¹¶å‘æ“ä½œï¼Œè€Œæ˜¯å¤„ç†ä¸€äº›ç®€å•çš„ã€åŸºäºäº‹ä»¶çš„æ“ä½œï¼Œå¦‚å“åº”ç”¨æˆ·çš„ç‚¹å‡»ã€è¾“å…¥ã€è¡¨å•æäº¤ç­‰

4ã€å¼‚æ­¥ç¼–ç¨‹å¼•å…¥

> è™½ç„¶JavaScriptæ˜¯å•çº¿ç¨‹çš„ï¼Œä½†é€šè¿‡å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹æ¥å®ç°éé˜»å¡çš„å¼‚æ­¥æ“ä½œ

5ã€Web Workersæä¾›å¤šçº¿ç¨‹æ”¯æŒ

> æµè§ˆå™¨æä¾›äº†Web Workersï¼Œå…è®¸å¼€å‘è€…åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡ŒJavaScriptè„šæœ¬ï¼Œè¿›è¡Œå¹¶è¡Œå¤„ç†

> è¿™äº›çº¿ç¨‹ä¸ä¸»çº¿ç¨‹æ˜¯éš”ç¦»çš„ï¼Œå› æ­¤æ— æ³•ç›´æ¥è®¿é—®DOMï¼Œä¹Ÿæ²¡æœ‰å…±äº«å†…å­˜ï¼Œå‡å°‘äº†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„åŒæ­¥é—®é¢˜

### JavaScript è¿è¡Œ

JavaScript è¿è¡Œæ—¶ï¼Œä¸»çº¿ç¨‹ä¼šå½¢æˆä¸€ä¸ªæ ˆï¼Œè¿™ä¸ªæ ˆä¸»è¦æ˜¯è§£é‡Šå™¨ç”¨æ¥æœ€ç»ˆå‡½æ•°æ‰§è¡Œæµçš„ä¸€ç§æœºåˆ¶ã€‚é€šå¸¸è¿™ä¸ªæ ˆè¢«ç§°ä¸ºè°ƒç”¨æ ˆ Call Stackï¼Œæˆ–æ‰§è¡Œæ ˆ Execution Context Stack

è°ƒç”¨æ ˆï¼Œå…·æœ‰åè¿›å…ˆå‡ºçš„ç»“æ„ã€‚

è°ƒç”¨æ ˆå†…å­˜æ”¾çš„æ˜¯ä»£ç æ‰§è¡ŒæœŸé—´çš„æ‰€æœ‰æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚

- æ¯è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œè§£é‡Šå™¨å°±ä¼šæŠŠè¯¥å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡æ·»åŠ åˆ°è°ƒç”¨æ ˆå¹¶å¼€å§‹æ‰§è¡Œï¼›

- æ­£åœ¨è°ƒç”¨æ ˆä¸­æ‰§è¡Œçš„å‡½æ•°ï¼Œå¦‚æœè¿˜è°ƒç”¨äº†å…¶ä»–å‡½æ•°ï¼Œé‚£ä¹ˆæ–°å‡½æ•°ä¹Ÿä¼šè¢«æ·»åŠ åˆ°è°ƒç”¨æ ˆï¼Œå¹¶ç«‹å³æ‰§è¡Œï¼›

- å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œè§£é‡Šå™¨ä¼šå°†å…¶æ‰§è¡Œä¸Šä¸‹æ–‡æ¸…é™¤è°ƒç”¨æ ˆï¼Œç»§ç»­æ‰§è¡Œå‰©ä½™æ‰§è¡Œä¸Šä¸‹æ–‡çš„å‰©ä½™ä»£ç 

- åˆ†é…çš„è°ƒç”¨æ ˆç©ºé—´è¢«å æ»¡ï¼Œä¼šå¼•å‘â€œå †æ ˆæº¢å‡ºâ€é”™è¯¯ã€‚

### äº‹ä»¶å¾ªç¯

å•çº¿ç¨‹æ„å‘³ç€ä»»åŠ¡éœ€è¦ä¸€ä¸ªä¸€ä¸ªè¿›è¡Œï¼Œå¦‚æœæœ‰ä»»åŠ¡æ˜¯ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œé‚£ä¹ˆåœ¨ç”¨æˆ·æ“ä½œä¹‹å‰ï¼Œå…¶ä»–ä»»åŠ¡éƒ½ä¼šç­‰å¾…ï¼Œé¡µé¢å¤„äºå‡æ­»çŠ¶æ€ï¼Œä½“éªŒå¾ˆç³Ÿï¼Œæ‰€ä»¥å‡ºç°äº†å¼‚æ­¥ä»»åŠ¡ã€‚

JavaScript ä¸­ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½å¯ä»¥åˆ†ä¸ºï¼š

- åŒæ­¥ä»»åŠ¡ï¼šç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ï¼ŒåŒæ­¥ä»»åŠ¡ä¸€èˆ¬ä¼šç›´æ¥è¿›å…¥åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ

- å¼‚æ­¥ä»»åŠ¡ï¼šå¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¯”å¦‚ ajax ç½‘ç»œè¯·æ±‚ï¼ŒsetTimeout å®šæ—¶å‡½æ•°ç­‰

![alt text](image.png)

å¼‚æ­¥ä»»åŠ¡åˆå¯ä»¥åˆ†ä¸ºå®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ã€‚

å¸¸è§çš„å®ä»»åŠ¡ï¼š

- script(å¤–å±‚åŒæ­¥ä»£ç )

- setTimeout/setInterval

- UI rendering/UI äº‹ä»¶

- postMessageã€MessageChannel

- setImmediateã€I/O(Node.js)

å¸¸è§çš„å¾®ä»»åŠ¡ï¼š

- Promise.then

- MutationObserver

- Object.observer(å·²åºŸå¼ƒï¼ŒProxy å¯¹è±¡æ›¿ä»£)

- process.nextTickï¼ˆNode.jsï¼‰

`new Promiseæ˜¯åŒæ­¥ä»»åŠ¡ï¼Œç›´æ¥æ‰§è¡Œ`

![alt text](image-1.png)

#### async å’Œ await

async ç”¨æ¥å£°æ˜ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œè€Œ await æ˜¯ç”¨æ¥ç­‰å¾…å¼‚æ­¥æ–¹æ³•æ‰§è¡Œ

async å‡½æ•°è¿”å›ä¸€ä¸ª promise å¯¹è±¡

```js
function f() {
  return Promise.resolve("TEST");
}

async function asyncF() {
  return "TEST";
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œawait å‘½ä»¤åé¢æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè¿”å›è¯¥å¯¹è±¡çš„ç»“æœ

å¦‚æœä¸æ˜¯ Promise å¯¹è±¡ï¼Œå°±ç›´æ¥è¿”å›å¯¹åº”çš„å€¼

```js
async function f() {
  return await 123;
  // ç­‰åŒäºreturn 123;
}

f().then((v) => console.log(v));
// 123
```

ä½†ä¸ç®¡ await åé¢è·Ÿç€çš„æ˜¯ä»€ä¹ˆï¼Œawait éƒ½ä¼šé˜»å¡åé¢çš„ä»£ç 

```js
async function fn1() {
  console.log(1);

  await fn2();

  console.log(2); //è¢«é˜»å¡
}

async function fn2() {
  console.log("fn2");
}

fn1();

console.log(3);

// awaitä¼šé˜»å¡ä¸‹é¢çš„ä»£ç ï¼Œå³åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå…ˆæ‰§è¡Œasyncå¤–é¢çš„åŒæ­¥ä»£ç ï¼ŒåŒæ­¥ä»£ç æ‰§è¡Œå®Œï¼Œå†å›åˆ°asyncå‡½æ•°ä¸­ï¼Œå†æ‰§è¡Œä¹‹å‰é˜»å¡çš„ä»£ç 
// 1,fn2,3,2
```

ç¤ºä¾‹ï¼š

```js
async function async1() {
  console.log("async1 start");
  await async2();
  console.log("async1 end");
}
async function async2() {
  console.log("async2");
}
console.log("script start");
setTimeout(function () {
  console.log("settimeout");
});
async1();
new Promise(function (resolve) {
  console.log("promise1");
  resolve();
}).then(function () {
  console.log("promise2");
});
console.log("script end");
// script startã€async1 startã€async2ã€promise1ã€script endã€async1 endã€promise2ã€settimeout
```

#### async/await å…¶ä»–ç»†èŠ‚

```js
async function async1 () {
 Â  Â await new Promise((resolve, reject) => {
 Â  Â  Â  Â resolve()
 Â   })
 Â  Â console.log('A')
}
â€‹
async1()
â€‹
new Promise((resolve) => {
 Â  Â console.log('B')
 Â  Â resolve()
}).then(() => {
 Â  Â console.log('C')
}).then(() => {
 Â  Â console.log('D')
})
â€‹
// æœ€ç»ˆç»“æœğŸ‘‰: B A C D


async function async1 () {
 Â  Â await async2()
 Â  Â console.log('A')
}
â€‹
async function async2 () {
 Â  Â return new Promise((resolve, reject) => {
 Â  Â  Â  Â resolve()
 Â   })
}
â€‹
async1()
â€‹
new Promise((resolve) => {
 Â  Â console.log('B')
 Â  Â resolve()
}).then(() => {
 Â  Â console.log('C')
}).then(() => {
 Â  Â console.log('D')
})
â€‹
// æœ€ç»ˆç»“æœğŸ‘‰: B C D A
```

async å‡½æ•°å¤„ç†è¿”å›å€¼ï¼Œä¼šåƒ Promise.prototype.then ä¸€æ ·ï¼Œä¼šå¯¹è¿”å›å€¼çš„ç±»å‹è¿›è¡Œè¾¨è¯†

ğŸ‘‰ æ ¹æ®è¿”å›å€¼çš„ç±»å‹ï¼Œå¼•èµ· js å¼•æ“ å¯¹è¿”å›å€¼å¤„ç†æ–¹å¼çš„ä¸åŒ

> ğŸ“‘ ç»“è®ºï¼šasync å‡½æ•°åœ¨æŠ›å‡ºè¿”å›å€¼æ—¶ï¼Œä¼šæ ¹æ®è¿”å›å€¼ç±»å‹å¼€å¯ä¸åŒæ•°ç›®çš„å¾®ä»»åŠ¡
>
> - return ç»“æœå€¼ï¼šé thenableã€é promiseï¼ˆä¸ç­‰å¾…ï¼‰
>
> - return ç»“æœå€¼ï¼šthenableï¼ˆç­‰å¾… 1 ä¸ª then çš„æ—¶é—´ï¼‰
>
> - return ç»“æœå€¼ï¼špromiseï¼ˆç­‰å¾… 2 ä¸ª then çš„æ—¶é—´ï¼‰

```js
async function testA () {
 Â  Â return 1;
}
â€‹
testA().then(() => console.log(1));
Promise.resolve()
 Â   .then(() => console.log(2))
 Â   .then(() => console.log(3));
â€‹
// (ä¸ç­‰å¾…)æœ€ç»ˆç»“æœğŸ‘‰: 1 2 3


async function testB () {
 Â  Â return {
 Â  Â  Â  Â then (cb) {
 Â  Â  Â  Â  Â  Â cb();
 Â  Â  Â   }
 Â   };
}
â€‹
testB().then(() => console.log(1));
Promise.resolve()
 Â   .then(() => console.log(2))
 Â   .then(() => console.log(3));
â€‹
// (ç­‰å¾…ä¸€ä¸ªthen)æœ€ç»ˆç»“æœğŸ‘‰: 2 1 3

async function testC () {
Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  resolve()
Â  Â  })
}

testC().then(() => console.log(1));
Promise.resolve()
Â  Â  .then(() => console.log(2))
Â  Â  .then(() => console.log(3));

// (ç­‰å¾…ä¸¤ä¸ªthen)æœ€ç»ˆç»“æœğŸ‘‰: 2 3 1




async function testC () {
Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  resolve()
Â  Â  })
}

testC().then(() => console.log(1));
Promise.resolve()
Â  Â  .then(() => console.log(2))
Â  Â  .then(() => console.log(3))
Â  Â  .then(() => console.log(4))

// (ç­‰å¾…ä¸¤ä¸ªthen)æœ€ç»ˆç»“æœğŸ‘‰: 2 3 1 4

```

```js
async function async1 () {
 Â  Â console.log('1')
 Â  Â await async2()
 Â  Â console.log('AAA')
}
â€‹
async function async2 () {
 Â  Â console.log('3')
 Â  Â return new Promise((resolve, reject) => {
 Â  Â  Â  Â resolve()
 Â  Â  Â  Â console.log('4')
 Â   })
}
â€‹
console.log('5')
â€‹
setTimeout(() => {
 Â  Â console.log('6')
}, 0);
â€‹
async1()
â€‹
new Promise((resolve) => {
 Â  Â console.log('7')
 Â  Â resolve()
}).then(() => {
 Â  Â console.log('8')
}).then(() => {
 Â  Â console.log('9')
}).then(() => {
 Â  Â console.log('10')
})
console.log('11')
â€‹
// æœ€ç»ˆç»“æœğŸ‘‰: 5 1 3 4 7 11 8 9 AAA 10 6

```

è·Ÿ Promise çš„æƒ…å†µ

```js
async function test () {
 Â  Â console.log(1);
 Â  Â await new Promise((resolve, reject) => {
 Â  Â  Â  Â resolve()
 Â   })
 Â  Â console.log(2);
}
â€‹
test();
console.log(3);
â€‹
Promise.resolve()
 Â   .then(() => console.log(4))
 Â   .then(() => console.log(5))
 Â   .then(() => console.log(6))
 Â   .then(() => console.log(7));
â€‹
// æœ€ç»ˆç»“æœğŸ‘‰: 1 3 2 4 5 6 7

// ä¸ºä»€ä¹ˆä¸ç­‰å¾…ä¸¤ä¸ª then çš„æ—¶é—´å‘¢ï¼Ÿ
// TC 39(ECMAScriptæ ‡å‡†åˆ¶å®šè€…) å¯¹await åé¢æ˜¯ promise çš„æƒ…å†µå¦‚ä½•å¤„ç†è¿›è¡Œäº†ä¸€æ¬¡ä¿®æ”¹ï¼Œç§»é™¤äº†é¢å¤–çš„ä¸¤ä¸ªå¾®ä»»åŠ¡ï¼Œåœ¨æ—©æœŸç‰ˆæœ¬ï¼Œä¾ç„¶ä¼šç­‰å¾…ä¸¤ä¸ª then çš„æ—¶é—´
// ä½†åœ¨è¿™æ¬¡æ›´æ–°ä¸­å¹¶æ²¡æœ‰ä¿®æ”¹ thenable çš„æƒ…å†µ
// è¿™æ ·åšå¯ä»¥æå¤§çš„ä¼˜åŒ– await ç­‰å¾…çš„é€Ÿåº¦
```

## äº‹ä»¶å¾ªç¯

JavaScript ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé™¤äº†ä¾é å‡½æ•°`è°ƒç”¨æ ˆ`æ¥æå®šå‡½æ•°çš„æ‰§è¡Œé¡ºåºå¤–ï¼Œè¿˜ä¾é `ä»»åŠ¡é˜Ÿåˆ—(task queue)`æ¥æå®šå¦å¤–ä¸€äº›ä»£ç çš„æ‰§è¡Œã€‚æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬ç§°ä¸ºäº‹ä»¶å¾ªç¯è¿‡ç¨‹ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œäº‹ä»¶å¾ªç¯æ˜¯å”¯ä¸€çš„ï¼Œä½†æ˜¯ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥æ‹¥æœ‰å¤šä¸ªã€‚ä»»åŠ¡é˜Ÿåˆ—åˆåˆ†ä¸º macro-taskï¼ˆå®ä»»åŠ¡ï¼‰ä¸ micro-taskï¼ˆå¾®ä»»åŠ¡ï¼‰ï¼Œåœ¨æœ€æ–°æ ‡å‡†ä¸­ï¼Œå®ƒä»¬è¢«åˆ†åˆ«ç§°ä¸º task ä¸ jobsã€‚

æ‰§è¡Œé¡ºåºï¼š

```js
æ‰§è¡ŒåŒæ­¥ä»£ç 

æ‰§è¡Œå®Œæ‰€æœ‰åŒæ­¥ä»£ç åä¸”æ‰§è¡Œæ ˆä¸ºç©ºï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¾®ä»»åŠ¡éœ€è¦æ‰§è¡Œ

æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡ä¸”å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º

æ˜¯å¦æœ‰å¿…è¦æ¸²æŸ“é¡µé¢

æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡
```

macro-task å¤§æ¦‚åŒ…æ‹¬ï¼š

- script(æ•´ä½“ä»£ç ï¼Œå¯ä»¥ç†è§£ä¸ºå¤–å±‚åŒæ­¥ä»£ç )

- setTimeout

- setInterval

- setImmediate

- I/O

- UI render

micro-task å¤§æ¦‚åŒ…æ‹¬:

- process.nextTick

- Promise

- Async/Await(å®é™…å°±æ˜¯ promise)

- MutationObserver(html5 æ–°ç‰¹æ€§)

![alt text](image-2.png)

## Nodeä¸­çš„äº‹ä»¶å¾ªç¯

Nodeä¸­çš„Event Loopå’Œæµè§ˆå™¨ä¸­çš„æ˜¯å®Œå…¨ä¸åŒçš„ä¸œè¥¿

![alt text](image-31.png)

Nodeé‡‡ç”¨V8ä½œä¸ºjsçš„è§£æå¼•æ“ï¼Œè€ŒI/Oå¤„ç†æ–¹é¢ä½¿ç”¨äº†è‡ªå·±è®¾è®¡çš„libuvï¼Œlibuvæ˜¯ä¸€ä¸ªåŸºäºäº‹ä»¶é©±åŠ¨çš„è·¨å¹³å°æŠ½è±¡å±‚ï¼Œå°è£…äº†ä¸åŒæ“ä½œç³»ç»Ÿçš„ä¸€äº›åº•å±‚ç‰¹æ€§ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„APIï¼ˆæ—¶é—´ï¼Œéé˜»å¡çš„ç½‘ç»œï¼Œå¼‚æ­¥æ–‡ä»¶æ“ä½œï¼Œå­è¿›ç¨‹ç­‰ç­‰ï¼‰ï¼ŒEvent Loopä¹Ÿæ˜¯å®ƒé‡Œé¢çš„å®ç°ã€‚

> Nodeçš„è¿è¡Œæœºåˆ¶ï¼š
> 
> V8å¼•æ“è§£æJavaScriptè„šæœ¬
> 
> è§£æåçš„ä»£ç ï¼Œè°ƒç”¨Node API
> 
> libuvåº“è´Ÿè´£Node APIçš„æ‰§è¡Œã€‚å°†ä¸åŒçš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œå½¢æˆä¸€ä¸ªEvent Loopï¼Œä»¥å¼‚æ­¥çš„æ–¹å¼å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™V8å¼•æ“
> 
> V8å¼•æ“å†å°†ç»“æœè¿”å›ç»™ç”¨æˆ·
> 

![alt text](image-32.png)

Nodeçš„Event Loopåˆ†ä¸º6ä¸ªé˜¶æ®µï¼ŒæŒ‰ç…§é¡ºåºåå¤è¿è¡Œã€‚æ¯å½“è¿›å…¥æŸä¸€ä¸ªé˜¶æ®µçš„æ—¶å€™ï¼Œéƒ½ä¼šä»å¯¹åº”çš„å›è°ƒé˜Ÿåˆ—ä¸­å–å‡ºå‡½æ•°å»æ‰§è¡Œï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…æ‰§è¡Œçš„å›è°ƒå‡½æ•°æ•°é‡è¾¾åˆ°ç³»ç»Ÿè®¾å®šçš„é˜ˆå€¼ï¼Œå°±ä¼šè¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚

1ã€Timersï¼ˆè®¡æ—¶å™¨é˜¶æ®µï¼‰ï¼šåˆæ¬¡è¿›å…¥äº‹ä»¶å¾ªç¯ï¼Œä¼šä»è®¡æ—¶å™¨é˜¶æ®µå¼€å§‹ã€‚æ­¤é˜¶æ®µä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿‡æœŸçš„è®¡æ—¶å™¨å›è°ƒï¼ˆåŒ…å«setTimeoutå’ŒsetIntervalï¼‰ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¼šæ‰§è¡Œæ‰€æœ‰è¿‡æœŸçš„è®¡æ—¶å™¨å›è°ƒï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œå¦‚æœå›è°ƒä¸­è§¦å‘äº†ç›¸åº”çš„å¾®ä»»åŠ¡ï¼Œä¼šæ¥ç€æ‰§è¡Œæ‰€æœ‰çš„å¾®ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œå¾®ä»»åŠ¡åå†è¿›å…¥Pending callbacksé˜¶æ®µã€‚

2ã€Pending callbacksï¼šæ‰§è¡Œæ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªå¾ªç¯è¿­ä»£çš„I/Oå›è°ƒ

3ã€Idle/Prepareï¼šä»…ä¾›å†…éƒ¨ä½¿ç”¨

4ã€Pollï¼ˆè½®è¯¢é˜¶æ®µï¼‰ï¼šå›åˆ°timeré˜¶æ®µæ‰§è¡Œå›è°ƒï¼Œæ‰§è¡ŒI/Oå›è°ƒ

> - å½“å›è°ƒé˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼šä¼šæ‰§è¡Œå›è°ƒï¼Œè‹¥å›è°ƒä¸­è§¦å‘äº†ç›¸åº”çš„å¾®ä»»åŠ¡ï¼Œè¿™é‡Œçš„å¾®ä»»åŠ¡æ‰§è¡Œæ—¶æœºå’Œå…¶ä»–åœ°æ–¹æœ‰æ‰€ä¸åŒï¼Œä¸ä¼šç­‰åˆ°æ‰€æœ‰å›è°ƒæ‰§è¡Œå®Œæ¯•åæ‰æ‰§è¡Œï¼Œè€Œæ˜¯é’ˆå¯¹æ¯ä¸€ä¸ªå›è°ƒæ‰§è¡Œå®Œæ¯•åï¼Œå°±æ‰§è¡Œç›¸åº”å¾®ä»»åŠ¡ã€‚æ‰§è¡Œå®Œæ‰€æœ‰çš„å›è°ƒåï¼Œå˜ä¸ºä¸‹é¢çš„æƒ…å†µã€‚
> 
> - å½“å›è°ƒé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ˆæ²¡æœ‰å›è°ƒæˆ–æ‰€æœ‰å›è°ƒæ‰§è¡Œå®Œæ¯•ï¼‰ï¼šä½†å¦‚æœå­˜åœ¨æœ‰è®¡æ—¶å™¨ï¼ˆsetTimeoutã€setIntervalå’ŒsetImmediateï¼‰æ²¡æœ‰æ‰§è¡Œï¼Œä¼šç»“æŸè½®è¯¢é˜¶æ®µï¼Œè¿›å…¥Checké˜¶æ®µã€‚å¦åˆ™ä¼šé˜»å¡å¹¶ç­‰å¾…ä»»ä½•æ­£åœ¨æ‰§è¡Œçš„I/Oæ“ä½œå®Œæˆï¼Œå¹¶é©¬ä¸Šæ‰§è¡Œç›¸åº”çš„å›è°ƒï¼Œç›´åˆ°æ‰€æœ‰å›è°ƒæ‰§è¡Œå®Œæ¯•
> 

5ã€Checkï¼ˆæŸ¥è¯¢é˜¶æ®µï¼‰ï¼šä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨setImmediateç›¸å…³çš„å›è°ƒï¼Œå¦‚æœå­˜åœ¨åˆ™æ‰§è¡Œæ‰€æœ‰å›è°ƒï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œå¦‚æœå›è°ƒä¸­è§¦å‘äº†ç›¸åº”çš„å¾®ä»»åŠ¡ï¼Œä¼šæ¥ç€æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œå¾®ä»»åŠ¡åå†è¿›å…¥Close callbacksé˜¶æ®µã€‚

6ã€Close callbacksï¼šæ‰§è¡Œä¸€äº›å…³é—­å›è°ƒï¼Œæ¯”å¦‚socket.on('close', ...)ç­‰ã€‚

### process.nextTick

process.nextTickæœ‰ä¸€ä¸ªè‡ªå·±çš„é˜Ÿåˆ—ï¼Œå½“æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œå¦‚æœå­˜åœ¨ nextTick é˜Ÿåˆ—ï¼Œå°±ä¼šæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”ä¼˜å…ˆäºå…¶ä»– microtask æ‰§è¡Œã€‚

### nodeä¸­çš„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

Nodeç«¯äº‹ä»¶å¾ªç¯ä¸­çš„å¼‚æ­¥é˜Ÿåˆ—ä¹Ÿæ˜¯è¿™ä¸¤ç§ï¼šmacroï¼ˆå®ä»»åŠ¡ï¼‰é˜Ÿåˆ—å’Œ microï¼ˆå¾®ä»»åŠ¡ï¼‰é˜Ÿåˆ—ï¼š

- å¸¸è§çš„ macro-task æ¯”å¦‚ï¼šsetTimeoutã€setIntervalã€ setImmediateã€scriptï¼ˆæ•´ä½“ä»£ç ï¼‰ã€ I/O æ“ä½œç­‰

- å¸¸è§çš„ micro-task æ¯”å¦‚: process.nextTickã€new Promise().then(å›è°ƒ)ç­‰


## å‚è€ƒ

[https://www.yuque.com/cuggz/interview/browser#a749f3035609d95dbdd1ee99d6f14b02](https://www.yuque.com/cuggz/interview/browser#a749f3035609d95dbdd1ee99d6f14b02)

[https://cchroot.github.io/interview/pages/interview%20notes/%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8ENode%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AFEvent%20Loop.html#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF-event-loop](https://cchroot.github.io/interview/pages/interview%20notes/%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8ENode%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AFEvent%20Loop.html#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF-event-loop)