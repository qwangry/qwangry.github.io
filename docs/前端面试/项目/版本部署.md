# 版本部署

## 灰度发布 Gray Release

核心理念：逐步引导一部分用户流量到新版本，同时`保留大部分用户在旧版本`，逐渐增加新版本的流量，直到全部切换到新版本。

关键点：在逐步增加流量的过程中，监控新版本的稳定性，确保不会造成大规模的用户影响。

适用场景：主要用于`功能上线`时，逐步发布，以减少对用户体验的影响。

## 金丝雀发布 Canary Release

核心理念：类似于灰度发布，但引导的流量非常小，一开始只针对极少数用户，`进行性能和稳定性验证`。

关键点：比灰度发布更谨慎，通常只占流量的很小比例，用于发现潜在的问题，避免大规模问题。

适用场景：用于验证新版本的性能和稳定性，通常在`正式发布之前`进行。

## 彩色发布 Canary Analysis

核心理念：基于金丝雀发布，进一步增加了`自动化分析工具`，以自动检测和评估新版本是否稳定。

关键点：自动化测试与监控结合，使用数据和分析来决定是否将更多流量引导到新版本，甚至完全切换到新版本。

适用场景：自动化工具较为成熟的团队，通过指标自动化检测，减少人工干预。

## 蓝绿发布 Blue-green deployment

核心理念：部署新版本时，旧版本继续运行。新版本完成部署并通过验证后，将流量切换到新版本，`旧版本保留一段时间`作为回退方案。

关键点：两个版本（蓝色和绿色）是完全独立的，用户只会同时访问其中一个版本。`切换是一次性完成的，不是逐步的`。

适用场景：希望在`无停机的情况下快速切换到新版本`，并且保持回滚的简单性。

## 滚动发布 Rolling Release

核心理念：逐步将新版本部署到生产环境中的不同实例（服务器或容器），逐步增加新版本的实例，直到所有实例都运行新版本。

关键点：新旧版本在一段时间内共存，逐步替换旧版本。`每次更新部分实例`，避免全局更新带来的风险。

适用场景：需要`平滑过渡的场景`，特别是需要维持高可用性且希望逐步替换服务的系统。

## A/B 测试 A/B Testing

核心理念：将用户流量分成两部分（A 和 B），每部分用户访问不同版本，收集用户行为和反馈数据，用于评估不同版本的效果和差异。

关键点：不仅仅是稳定性验证，更多用于对比两个不同版本的功能、UI、体验等，目的是找出哪个版本对用户体验更好。

适用场景：当需要测试新功能、设计、或特性对用户行为的影响时，通过 A/B 测试找到最佳版本。

## 增量部署 Incremental Deployment

核心理念：逐步将新版本的部分代码或功能部署到现有系统中，而不是一次性发布整个新版本。新旧代码共存，降低风险。

关键点：并非完全替换整个版本，而是逐步增加新的功能模块，同时保持大部分旧功能的运行。

适用场景：需要逐步上线功能，避免大规模发布风险时，使用增量式的部署方式。

## 可重入部署 Reentrant Deployment

核心理念：在部署新版本之前，确保现有系统可以随时回退到旧版本，且不会因为中途失败而产生副作用或破坏现有系统。

关键点：保证部署是幂等的，即部署操作可以安全地重复执行或中途恢复。出现问题时，系统可以自动回退到之前的版本。

适用场景：需要高度安全和可靠的部署过程，特别是希望在任何时候都可以回退时使用。

## 总结

- `灰度发布` 和 `金丝雀发布` 都是逐步引导流量到新版本，但`金丝雀发布`的流量引导比例更小，主要用于小范围的稳定性验证。

- `彩色发布` 是基于金丝雀发布增加了自动化的测试和分析，以确保`数据驱动决定流量切换`。

- `蓝绿发布` 是`一次性流量切换`，不是逐步引导，两个版本并行运行，用户一次只会看到一个版本。

- `滚动发布` 是逐步将新版本部署到不同的实例上，新旧版本共存一段时间，逐步完成替换。

- `A/B 测试` 是用户行为测试，目的是评估不同版本的效果，而不是为了系统`稳定性`验证。

- `增量部署` 是`逐步发布`部分代码或功能，而非完整的版本发布。

- `可重入部署` 强调的是部署的`安全性、回退的可行性和幂等性`，而不是流量管理。

## 参考

- [https://guide.duanhl.com/project/deploy/mode.html#%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83-gray-release](https://guide.duanhl.com/project/deploy/mode.html#%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83-gray-release)

- Chatgpt
